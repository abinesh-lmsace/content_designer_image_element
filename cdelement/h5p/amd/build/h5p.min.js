/**
 * Initializes and manages H5P elements within a Moodle environment.
 *
 * This module defines functions to handle user interactions with H5P content,
 * capturing xAPI events, and storing user responses. It listens for specific
 * xAPI verbs such as 'answered', 'completed', and 'interacted' to determine
 * when to store user responses. The module also handles the removal of warning
 * messages and refreshes content elements upon successful data storage.
 *
 * @module cdelement_h5p/h5p
 * @copyright  2024 bdecent gmbh <https://bdecent.de>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("cdelement_h5p/h5p",["jquery","mod_contentdesigner/elements","core/ajax","core/notification","cdelement_h5p/repository"],(function($,Elements,AJAX,Notification,Repository){var interactedInstances=[];const elementH5P=(instance,cdattemptid)=>{document.querySelector('.element-h5p .element-content[data-instanceid="'+instance+'"]').querySelector(".h5p-player").onload=()=>h5pExternal(instance,cdattemptid)},h5pExternal=(instance,cdattemptid)=>{var iframe=document.querySelector('.element-h5p .element-content[data-instanceid="'+instance+'"]').querySelector(".h5p-player");if(null!=iframe.contentWindow.H5P){var h5p=iframe.contentWindow.H5P;if(void 0!==h5p.externalDispatcher){var statementPosted=!1;h5p.externalDispatcher.on("xAPI",(function(event){if(event&&event.data&&event.data.statement){var statement=event.data.statement;if(statement.verb&&statement.verb.id){var extensionID,isCompleted="http://adlnet.gov/expapi/verbs/answered"===statement.verb.id||"http://adlnet.gov/expapi/verbs/completed"===statement.verb.id||"http://activitystrea.ms/schema/1.0/consume"===statement.verb.id,isChild=statement.context&&statement.context.contextActivities&&statement.context.contextActivities.parent&&statement.context.contextActivities.parent[0]&&statement.context.contextActivities.parent[0].id,isInteract="http://adlnet.gov/expapi/verbs/interacted"===statement.verb.id,isInteracted=!1,isResponsed=!1;if(isInteract)try{extensionID=statement.object.definition.extensions["http://h5p.org/x-api/h5p-local-content-id"],interactedInstances[extensionID]=!0}catch(err){Notification.alert(err)}else{try{var _interactedInstances$;extensionID=statement.object.definition.extensions["http://h5p.org/x-api/h5p-local-content-id"],isInteracted=null!==(_interactedInstances$=interactedInstances[extensionID])&&void 0!==_interactedInstances$&&_interactedInstances$}catch(err){Notification.alert(err)}if(void 0!==statement.result){if(void 0!==statement.result.response){for(var _statement$result$sco,max=null!==(_statement$result$sco=statement.result.score.max)&&void 0!==_statement$result$sco?_statement$result$sco:0,response=statement.result.response,i=1;i<=max;i++)response=response.replace("[,]","");isResponsed=""!=response}else{var _statement$result;isResponsed=!0,null!==(_statement$result=statement.result)&&void 0!==_statement$result&&_statement$result.completion&&(isInteract=statement.result.completion)}var isPassed=void 0===statement.result.score||(statement.result.score.max<1||statement.result.score.max==statement.result.score.raw||void 0!==statement.result.success&&1==statement.result.success);if(storeMaxscore(statement,instance),isCompleted&&!isChild&&isResponsed&&isInteracted&&isPassed){var promises=storeUserResponse(statement,instance,cdattemptid);if(!promises)return;statementPosted=!0,promises[0].then((response=>{response&&(removeWarning(),Elements.refreshContent())})).catch(Notification.exception)}}}}}})),h5p.externalDispatcher.on("xAPIState",(function(event){var moodlecomponent=h5p.getMoodleComponent(),contentId=event.data.activityId,stateId=event.data.stateId,registration="cdelement_h5p-"+instance,state=event.data.state;if(void 0!==state)if(null===state)Repository.deleteState(moodlecomponent,contentId,h5p.getxAPIActor(),stateId,registration);else if(!statementPosted){var statedata={h5p:state};Repository.postState(moodlecomponent,contentId,h5p.getxAPIActor(),stateId,JSON.stringify(statedata),registration)}}))}else setTimeout((()=>elementH5P(instance)),200)}else setTimeout((()=>elementH5P(instance)),200)},removeWarning=()=>{null!==Elements.courseContent().querySelector(".label.label-warning")&&Elements.courseContent().querySelector(".label.label-warning").remove()},storeMaxscore=(statement,instance)=>{var _statement$result$sco2,_statement$result$sco3,params={cmid:Elements.contentDesignerData().cmid,instanceid:instance,maxscore:null!==(_statement$result$sco2=null===(_statement$result$sco3=statement.result.score)||void 0===_statement$result$sco3?void 0:_statement$result$sco3.max)&&void 0!==_statement$result$sco2?_statement$result$sco2:0};return AJAX.call([{methodname:"cdelement_h5p_store_maxscore",args:params}])},storeUserResponse=(statement,instance,cdattemptid)=>{var _statement$result$com,_statement$result$suc,_statement$result$dur,_statement$result$res,_statement$result$sco4,_statement$result$sco5,_statement$result$sco6,_statement$result$sco7,params={cmid:Elements.contentDesignerData().cmid,instanceid:instance,cdattemptid:cdattemptid,result:{completion:null!==(_statement$result$com=statement.result.completion)&&void 0!==_statement$result$com?_statement$result$com:0,success:null!==(_statement$result$suc=statement.result.success)&&void 0!==_statement$result$suc?_statement$result$suc:0,duration:null!==(_statement$result$dur=statement.result.duration)&&void 0!==_statement$result$dur?_statement$result$dur:"",response:null!==(_statement$result$res=statement.result.response)&&void 0!==_statement$result$res?_statement$result$res:"",score:{min:null!==(_statement$result$sco4=statement.result.score.min)&&void 0!==_statement$result$sco4?_statement$result$sco4:0,max:null!==(_statement$result$sco5=statement.result.score.max)&&void 0!==_statement$result$sco5?_statement$result$sco5:0,raw:null!==(_statement$result$sco6=statement.result.score.raw)&&void 0!==_statement$result$sco6?_statement$result$sco6:0,scaled:null!==(_statement$result$sco7=statement.result.score.scaled)&&void 0!==_statement$result$sco7?_statement$result$sco7:0}}};return AJAX.call([{methodname:"cdelement_h5p_store_result",args:params}])};return{init:function(instance,cdattemptid){elementH5P(instance,cdattemptid)}}}));

//# sourceMappingURL=h5p.min.js.map